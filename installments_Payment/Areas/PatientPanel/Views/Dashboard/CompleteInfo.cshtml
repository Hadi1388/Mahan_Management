@using installments_Payment.Core.ViewModels
@using installments_Payment.Core.ViewModels.Patient
@model PatientEditInfoViewModel

@{
    ViewData["Title"] = "تکمیل اطلاعات";
    bool isRequestCompleted = Model.isRequestCompleted; // فرضاً فیلد isRequestCompleted داریم
}

<div class="container">
    <div class="card shadow-sm">
        <div class="card-header">
            <h2 class="text-2xl font-bold">تکمیل اطلاعات کاربری</h2>
        </div>
        <div class="card-body">
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    @TempData["ErrorMessage"]
                </div>
            }

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                    @TempData["SuccessMessage"]
                </div>
            }

            <form id="completeInfoForm" asp-action="CompleteInfo" method="post" enctype="multipart/form-data" novalidate>
                <div class="mb-4">
                    <label asp-for="SecondaryPhoneNumber" class="block text-gray-700 font-semibold mb-1"></label>
                    <input asp-for="SecondaryPhoneNumber" class="form-control w-full border border-gray-300 rounded px-3 py-2" style="text-align: right;" disabled="@(isRequestCompleted ? "disabled" : null)" />
                    <span asp-validation-for="SecondaryPhoneNumber" class="text-red-600 text-sm"></span>
                </div>

                <div class="mb-4">
                    <label asp-for="NationalCode" class="block text-gray-700 font-semibold mb-1"></label>
                    <input asp-for="NationalCode" class="form-control w-full border border-gray-300 rounded px-3 py-2" disabled="@(isRequestCompleted ? "disabled" : null)" />
                    <span asp-validation-for="NationalCode" class="text-red-600 text-sm"></span>
                </div>

                @if (!string.IsNullOrEmpty(Model.NationalCardImagePath))
                {
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-1">تصویر فعلی کارت ملی:</label>
                        <img src="@Model.NationalCardImagePath" alt="تصویر کارت ملی" style="max-width: 200px;" />
                        <span asp-validation-for="NationalCardImagePath" class="text-red-600 text-sm"></span>
                    </div>
                }

                <div class="mb-4">
                    <label asp-for="NationalCardImageFile" class="block text-gray-700 font-semibold mb-1"></label>
                    <input id="NationalCardImageFile" name="NationalCardImageFile" type="file" accept="image/*" class="form-control w-full border border-gray-300 rounded px-3 py-2" />
                    <div id="fileError" class="text-red-600 text-sm" style="display:none;">لطفاً تصویر کارت ملی خود را آپلود کنید</div>
                    <img id="previewImage" style="max-width: 200px; display:none; margin-top:10px;" />
                </div>

                <div class="mb-4">
                    <label asp-for="Address" class="block text-gray-700 font-semibold mb-1"></label>
                    <textarea asp-for="Address" rows="4" class="form-control w-full border border-gray-300 rounded px-3 py-2" disabled="@(isRequestCompleted ? "disabled" : null)"></textarea>
                    <span asp-validation-for="Address" class="text-red-600 text-sm"></span>
                </div>

                <hr class="mb-2" />
                <div class="d-flex justify-content-end">
                    @if (!isRequestCompleted)
                    {
                        <button type="submit" class="btn-gradient-green text-white font-bold py-2 px-4 rounded">ثبت اطلاعات</button>
                    }
                    <a href="Index" class="btn-gradient-gray text-white font-bold py-2 px-4 rounded mx-2">برگشت</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById("NationalCardImageFile");
    const preview = document.getElementById("previewImage");
    const form = document.getElementById("completeInfoForm");
    const fileError = document.getElementById("fileError");

    fileInput.addEventListener("change", function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = "block";
            }
            reader.readAsDataURL(file);
            fileError.style.display = "none"; // خطا حذف شود اگر فایلی انتخاب شد
        } else {
            preview.src = "";
            preview.style.display = "none";
        }
    });

    // بررسی قبل از ارسال فرم
    form.addEventListener("submit", function(e) {
        // اگر هیچ فایلی انتخاب نشده و تصویر قبلی هم وجود ندارد
        const hasExisting = '@Model.NationalCardImagePath' !== '';
        if (!fileInput.files[0] && !hasExisting) {
            e.preventDefault(); // جلوگیری از ارسال فرم
            fileError.style.display = "block"; // نمایش خطا
        }
    });
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />


    <script>
        const fileInput = document.getElementById("NationalCardImageFile");
        const preview = document.getElementById("previewImage");

        fileInput.addEventListener("change", function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = "block";
                }
                reader.readAsDataURL(file);
            } else {
                preview.src = "";
                preview.style.display = "none";
            }
        });
    </script>
}

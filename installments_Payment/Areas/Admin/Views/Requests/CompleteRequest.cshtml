@using installments_Payment.Core.ViewModels.Request
@model RequestCompleteViewModel

@{
    ViewData["Title"] = "ØªÚ©Ù…ÛŒÙ„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª";
    var treatmentTypes = (SelectList)ViewData["TreatmentTypes"];
    var treatments = (SelectList)ViewData["Treatments"];
}

<div class="container">
    <div class="card shadow-sm">
        <div class="card-body">
            <form asp-action="CompleteRequest" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="RequestId" />
                <input type="hidden" asp-for="FullName" />
                <input type="hidden" asp-for="NationalCode" />
                <input type="hidden" asp-for="PrimaryPhoneNumber" />
                <input type="hidden" asp-for="SecondaryPhoneNumber" />
                <input type="hidden" asp-for="NationalCardImagePath" />
                <input type="hidden" asp-for="Address" />

                <fieldset class="border p-3 mb-3">
                    <legend>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±</legend>
                    <div class="mb-3">
                        <label asp-for="FullName" class="form-label"></label>: <span class="text-primary">@Model.FullName</span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="NationalCardImagePath" class="form-label"></label>: <a href="@Model.NationalCardImagePath" class="text-primary">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>
                    </div>
                    <div class="mb-3">
                        <label asp-for="NationalCode" class="form-label"></label>: <span class="text-primary">@Model.NationalCode</span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="PrimaryPhoneNumber" class="form-label"></label>: <span class="text-primary">@Model.PrimaryPhoneNumber</span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="SecondaryPhoneNumber" class="form-label"></label>: <span class="text-primary">@Model.SecondaryPhoneNumber</span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Address" class="form-label"></label>: <span class="text-primary">@Model.Address</span>
                    </div>
                </fieldset>

                <fieldset class="border p-3 mb-3">
                    <legend>ØªÚ©Ù…ÛŒÙ„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª</legend>

                    <div class="mb-3">
                        <label asp-for="TreatmentTypeId"></label>
                        <select asp-for="TreatmentTypeId" asp-items="treatmentTypes" class="form-control"></select>
                        <span asp-validation-for="TreatmentTypeId" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="TreatmentId"></label>
                        <select asp-for="TreatmentId" asp-items="treatments" class="form-control"></select>
                        <span asp-validation-for="TreatmentId" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¯Ø±Ù…Ø§Ù†</label>
                        <div class="input-group">
                            <span id="StartDatePicker" class="input-group-text cursor-pointer">ğŸ“…</span>
                            <input type="text" id="StartDateInput" placeholder="ØªØ§Ø±ÛŒØ® Ø¯Ø±Ù…Ø§Ù†" data-name="start-date-text" class="form-control" />
                            <input type="hidden" data-name="start-date-value" name="StartDate" />
                        </div>
                        <div id="StartDateError" class="text-danger"></div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="PaymentType" class="form-label"></label>
                        <select asp-for="PaymentType" id="PaymentType" class="form-select"
                                asp-items="Html.GetEnumSelectList<installments_Payment.Core.Enums.PaymentTypes>()">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                        </select>
                        <span asp-validation-for="PaymentType" class="text-danger"></span>
                    </div>


                    <div class="mb-3">
                        <label asp-for="GuaranteeType" class="form-label"></label>
                        <select asp-for="GuaranteeType" id="guarntee-type" class="form-select" asp-items="Html.GetEnumSelectList<installments_Payment.Core.Enums.GuaranteeTypes>()">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                        </select>
                        <span asp-validation-for="GuaranteeType" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="DoctorName" class="form-label"></label>
                        <input asp-for="DoctorName" class="form-control" />
                        <span asp-validation-for="DoctorName" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="TotalAmount" class="form-label"></label>
                        <input asp-for="TotalAmount" id="TotalAmount" min="0" step="1" class="form-control" />
                        <span asp-validation-for="TotalAmount" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Prepayment" class="form-label"></label>
                        <input asp-for="Prepayment" id="PrePayment" min="0" step="1" class="form-control" />
                        <span asp-validation-for="Prepayment" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="InstallmentsCount" class="form-label"></label>
                        <input asp-for="InstallmentsCount" class="form-control" id="installmentsCount" />
                        <span asp-validation-for="InstallmentsCount" class="text-danger"></span>
                    </div>
                </fieldset>

                <fieldset class="border p-3 mb-3" id="checkNumber">
                    <legend>ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ùˆ Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ«ÛŒÙ‚Ù‡</legend>
                    <div id="guarantee-section">
                        <div class="row mb-2 guarantee-item">
                            <div class="col-md-6">
                                <label>ÙØ§ÛŒÙ„ ÙˆØ«ÛŒÙ‚Ù‡</label>
                                <input type="file" name="GuaranteeFiles" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label>Ø´Ù…Ø§Ø±Ù‡ ÙˆØ«ÛŒÙ‚Ù‡</label>
                                <input type="text" name="GuaranteeNumbers[0]" class="form-control" />
                            </div>
                        </div>
                    </div>
                    <hr />
                    <button type="button" class="btn-gradient-green mt-2" id="add-guarantee">Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ«ÛŒÙ‚Ù‡ Ø¬Ø¯ÛŒØ¯</button>
                </fieldset>

                <div class="d-flex justify-content-end mt-2">
                    <button type="submit" class="bg-gradient-to-r from-green-primary to-green-dark text-white px-4 py-2 rounded-full font-medium hover:opacity-90 transitionn mx-1">Ø«Ø¨Øª</button>
                    <a asp-action="Index" class="btn-gradient-gray">Ø§Ù†ØµØ±Ø§Ù</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.querySelector("form").addEventListener("submit", function (e) {
            let startDateInput = document.getElementById("StartDateInput");
            let errorDiv = document.getElementById("StartDateError");

            errorDiv.textContent = ""; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø®Ø·Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ

            if (startDateInput.value.trim() === "") {
                e.preventDefault();

                // Ù†Ù…Ø§ÛŒØ´ Ù…ØªÙ† Ø®Ø·Ø§
                errorDiv.textContent = "Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¯Ø±Ù…Ø§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.";

                // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù…Ø­Ù„ Ø®Ø·Ø§ (Ú©Ù…ÛŒ Ø¨Ø§Ù„Ø§ØªØ±)
                const yOffset = -100; // Ú†Ù‚Ø¯Ø± Ø¨Ø§Ù„Ø§ØªØ± Ø¨Ø±Ù‡
                const y = startDateInput.getBoundingClientRect().top + window.scrollY + yOffset;
                window.scrollTo({ top: y, behavior: 'smooth' });
            }
        });



        const startDatePicker = new mds.MdsPersianDateTimePicker(document.getElementById('StartDatePicker'), {
            targetTextSelector: '[data-name="start-date-text"]',
            targetDateSelector: '[data-name="start-date-value"]',
            enableTimePicker: true,           // Ø§ÛŒÙ†Ø¬Ø§ ÙØ¹Ø§Ù„ Ø´Ø¯Ù† Ø³Ø§Ø¹Øª
            textFormat: 'yyyy/MM/dd HH:mm',   // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± input
            dateFormat: 'yyyy-MM-dd HH:mm'    // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ hidden Ùˆ Ù…Ø¯Ù„
        });

        function toggleFieldsBasedOnPaymentType() {
            var paymentType = document.getElementById("PaymentType").value;
            var isCash = paymentType === "2"; // Ø§ÛŒÙ†Ø¬Ø§ Ù…Ù‚Ø¯Ø§Ø± enum Ù†Ù‚Ø¯ÛŒ

            // Ø§Ù‚Ø³Ø§Ø·
            var installmentsCount = document.getElementById("installmentsCount");
            installmentsCount.disabled = isCash;
            if (isCash) installmentsCount.value = "";

            // Ù†ÙˆØ¹ ÙˆØ«ÛŒÙ‚Ù‡
            var guaranteeType = document.getElementById("guarntee-type");
            guaranteeType.disabled = isCash;
            if (isCash) guaranteeType.value = "";

            // Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† Ø¶Ù…Ø§Ù†Øª
            document.getElementById("add-guarantee").disabled = isCash;

            // Ù‡Ù…Ù‡ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø®Ø´ Ø¶Ù…Ø§Ù†Øª (Ø´Ù…Ø§Ø±Ù‡ Ùˆ ÙØ§ÛŒÙ„)
            document.querySelectorAll("#checkNumber input").forEach(function (el) {
                el.disabled = isCash;
                if (isCash) {
                    if (el.type === "file") {
                        el.value = null; // ÙØ§ÛŒÙ„ Ø±Ùˆ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù‡
                    } else {
                        el.value = ""; // Ù…ØªÙ† Ø±Ùˆ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù‡
                    }
                }
            });
        }

        // Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØºÛŒÛŒØ± Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª
        document.getElementById("PaymentType").addEventListener("change", toggleFieldsBasedOnPaymentType);

        // Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        toggleFieldsBasedOnPaymentType();

        let count = 1; // Ú†ÙˆÙ† ÛŒÚ© Ø¬ÙØª Ø§ÙˆÙ„ Ù‡Ø³Øª
        document.getElementById('add-guarantee').addEventListener('click', function () {
            var container = document.getElementById('guarantee-section');
            var html = `
                <div class="row mb-2 guarantee-item">
                    <div class="col-md-6">
                        <label>ÙØ§ÛŒÙ„ ÙˆØ«ÛŒÙ‚Ù‡</label>
                        <input type="file" name="GuaranteeFiles" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label>Ø´Ù…Ø§Ø±Ù‡ ÙˆØ«ÛŒÙ‚Ù‡</label>
                        <input type="text" name="GuaranteeNumbers[${count}]" class="form-control" />
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
            count++;
        });
    </script>
            }
